<!DOCTYPE html>
<html>
<head>
    <title>Czech Republic Housing Prices & Supermarkets Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .map-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        .map-title h1 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }
        .map-title p {
            margin: 5px 0 0 0;
            font-size: 14px;
            color: #666;
        }
        .legend {
            line-height: 18px;
            color: #555;
            background: white;
            padding: 10px;
            border-radius: 5px;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.85;
        }
        .legend .marker-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2196F3;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.4);
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
    </style>
</head>
<body>

<div class="map-title">
    <h1>Czech Republic Housing Market & Supermarkets</h1>
    <p>Housing prices by region and supermarket locations</p>
</div>

<div id="map"></div>

<script>
    // 1. Initialize the map with clustering support
    const map = L.map('map').setView([49.8175, 15.4730], 7);

    // Add tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attribution">CARTO</a>'
    }).addTo(map);

    // Create a marker cluster group
    const markers = L.markerClusterGroup();

// 2. Define regional housing price data
    // Data mapped to match GeoJSON region names
    const regionalPrices = {
        "Prague": 124900,
        "Středočeský": 75000,
        "Jihočeský": 67600,
        "Plzeňský": 65000,
        "Karlovarský": 45000,
        "Ústecký": 42000,
        "Liberecký": 71000,
        "Královéhradecký": 69000,
        "Pardubický": 64000,
        "KrajVysočina": 58000,
        "Jihomoravský": 102000,
        "Olomoucký": 61000,
        "Zlínský": 59000,
        "Moravskoslezský": 48000
    };

    // Create a mapping between GeoJSON names and our price data names
    const regionNameMap = {
        "Jihočeský": "Jihočeský",
        "Jihomoravský": "Jihomoravský",
        "Karlovarský": "Karlovarský",
        "KrajVysočina": "KrajVysočina",
        "Královéhradecký": "Královéhradecký",
        "Liberecký": "Liberecký",
        "Moravskoslezský": "Moravskoslezský",
        "Olomoucký": "Olomoucký",
        "Pardubický": "Pardubický",
        "Plzeňský": "Plzeňský",
        "Prague": "Prague",
        "Středočeský": "Středočeský",
        "Ústecký": "Ústecký",
        "Zlínský": "Zlínský",
        // Add mappings for any variations in the GeoJSON
        "Kraj Vysočina": "KrajVysočina"
    };

    // 3. Define styling functions
    function getColor(price) {
        return price > 100000 ? '#67000d' :
               price > 80000 ? '#a50f15' :
               price > 60000 ? '#de2d26' :
               price > 50000 ? '#fb6a4a' :
               price > 40000 ? '#fc9272' :
               price > 30000 ? '#fcbba1' :
                              '#fee5d9';
    }

function styleFeature(feature) {
        const regionName = feature.properties.NAME_1;
        const mappedName = regionNameMap[regionName] || regionName;
        const price = regionalPrices[mappedName];
        return {
            fillColor: getColor(price),
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.85
        };
    }

    // 4. Define interactivity functions
    function onEachFeature(feature, layer) {
        // Adjust this property name based on your GeoJSON file
        const regionName = feature.properties.NAME_1; 
        if (feature.properties && regionName) {
            const mappedName = regionNameMap[regionName] || regionName;
            const price = regionalPrices[mappedName] || 'N/A';
            layer.bindPopup(
                `<div style="font-family: Arial, sans-serif; padding: 4px;">
                    <h3 style="margin: 0 0 8px 0;">${regionName}</h3>
                    <div style="font-size: 14px;">
                        <strong>Average Price:</strong><br>
                        <span style="color: #d73027; font-size: 16px; font-weight: bold;">
                            ${price.toLocaleString()} CZK/m²
                        </span>
                    </div>
                </div>`
            );

            layer.on({
                mouseover: (e) => {
                    const layer = e.target;
                    layer.setStyle({
                        weight: 5,
                        color: '#666',
                        dashArray: '',
                        fillOpacity: 0.9
                    });
                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                        layer.bringToFront();
                    }
                },
                mouseout: (e) => {
                    geojsonLayer.resetStyle(e.target);
                }
            });
        }
    }

    // 5. Load GeoJSON and supermarket data
    let geojsonLayer;

    // Function to create markers for supermarkets
    function addSupermarketMarkers() {
        fetch('supermarkets.geojson')
            .then(response => response.json())
            .then(data => {
                const supermarketIcon = L.divIcon({
                    html: '<div style="background-color: #2196F3; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.4);"></div>',
                    className: 'supermarket-marker',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });

                L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, {icon: supermarketIcon});
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties) {
                            layer.bindPopup(`
                                <div style="font-family: Arial, sans-serif;">
                                    <b>${feature.properties.name || 'Supermarket'}</b><br>
                                    ${feature.properties.city || ''}
                                </div>
                            `);
                        }
                    }
                }).addTo(markers);
            })
            .catch(error => console.error('Error loading supermarket data:', error));
    }

    // Load region data
    fetch('czech_regions.geojson')
        .then(response => response.json())
        .then(data => {
            geojsonLayer = L.geoJSON(data, {
                style: styleFeature,
                onEachFeature: onEachFeature
            }).addTo(map);

            // Add legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'legend');
                const grades = [0, 30000, 40000, 50000, 60000, 80000, 100000];
                const labels = [];

                div.innerHTML = '<h4 style="margin:0 0 10px 0">Average Price CZK/m²</h4>';

                // Price ranges
                for (let i = 0; i < grades.length; i++) {
                    const from = grades[i];
                    const to = grades[i + 1];

                    labels.push(
                        '<i style="background:' + getColor(from + 1) + '"></i> ' +
                        from.toLocaleString() + (to ? '&ndash;' + to.toLocaleString() : '+'));
                }

                // Add marker legend
                labels.push('<br><br><div class="marker-icon"></div> Supermarket Location');

                div.innerHTML += labels.join('<br>');
                return div;
            };
            legend.addTo(map);

            // Add supermarket markers
            addSupermarketMarkers();
        })
        .catch(error => {
            console.error('Error loading or parsing GeoJSON:', error);
            alert('Could not load map data. Please make sure all required files are in the correct directory.');
        });

    // Add marker cluster group to map
    map.addLayer(markers);

</script>

</body>
</html>
